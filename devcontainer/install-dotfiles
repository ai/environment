#!/bin/sh

# Detect system architecture
ARCH=$(uname -m)
echo "Detected architecture: $ARCH"
case "$ARCH" in
  x86_64)
    ARCH_SUFFIX="x86_64-unknown-linux-musl"
    ;;
  aarch64)
    ARCH_SUFFIX="aarch64-unknown-linux-gnu"
    ;;
  *)
    echo "Unsupported architecture: $ARCH"
    exit 1
    ;;
esac

mkdir -p ~/.config/micro
mkdir -p ~/.config/bat
mkdir -p ~/.config/git

cp -f ~/dotfiles/zshrc ~/.zshrc
cp -f ~/dotfiles/gitconfig ~/.config/git/config
cp -f ~/dotfiles/ripgreprc ~/.config/ripgreprc
cp -f ~/dotfiles/micro.json ~/.config/micro/settings.json
cp -f ~/dotfiles/batconfig ~/.config/bat/config
cp -f ~/dotfiles/gitignore ~/.config/git/ignore
cp -f ~/dotfiles/starship.toml ~/.config/starship.toml
sed -i '/^\s*\$username\\/d;/^\s*\$hostname\\/d' ~/.config/starship.toml

mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDwZrgt8W9uGndgD2aoMOjN0lhvFYsYzfietr5gu5lUV andrey@sitnik.ru" > ~/.ssh/authorized_keys
chmod 644 ~/.ssh/authorized_keys
echo "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl" > ~/.ssh/known_hosts
echo "github.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=" > ~/.ssh/known_hosts
echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=" > ~/.ssh/known_hosts
chmod 600 ~/.ssh/known_hosts

mkdir -p ~/.local/share/history/
touch ~/.local/share/history/histfile
mkdir -p ~/.local/bin

if ! command -v micro >/dev/null 2>&1; then
  MICRO_VERSION="2.0.14"
  if [ "$ARCH" = "x86_64" ]; then
    MICRO_ARCH="linux64-static"
  else
    MICRO_ARCH="linux-arm64"
  fi
  curl -sL https://github.com/zyedidia/micro/releases/download/v$MICRO_VERSION/micro-$MICRO_VERSION-$MICRO_ARCH.tar.gz | tar xz
  mv micro-$MICRO_VERSION/micro ~/.local/bin
  chmod +x ~/.local/bin/micro
  rm -rf micro-$MICRO_VERSION
fi

if command -v micro >/dev/null 2>&1; then
  micro -plugin install editorconfig
elif [ -f ~/.local/bin/micro ]; then
  ~/.local/bin/micro -plugin install editorconfig
fi

curl -sL https://github.com/eza-community/eza/releases/latest/download/eza_$ARCH_SUFFIX.tar.gz | tar xz
chmod +x eza
mv eza ~/.local/bin

DIFFT_VERSION="0.65.0"
curl -sL https://github.com/Wilfred/difftastic/releases/download/$DIFFT_VERSION/difft-$ARCH_SUFFIX.tar.gz | tar xz
chmod +x difft
mv difft ~/.local/bin

BAT_VERSION="0.26.0"
curl -sL https://github.com/sharkdp/bat/releases/download/v$BAT_VERSION/bat-v$BAT_VERSION-$ARCH_SUFFIX.tar.gz | tar xz --strip-components=1 bat-v$BAT_VERSION-$ARCH_SUFFIX/bat
chmod +x bat
mv bat ~/.local/bin

RG_VERSION="15.1.0"
curl -sL https://github.com/BurntSushi/ripgrep/releases/download/$RG_VERSION/ripgrep-$RG_VERSION-$ARCH_SUFFIX.tar.gz | tar xz --strip-components=1 ripgrep-$RG_VERSION-$ARCH_SUFFIX/rg
chmod +x rg
mv rg ~/.local/bin

ATUN_VERSION="18.10.0"
curl -sL https://github.com/atuinsh/atuin/releases/download/v$ATUN_VERSION/atuin-$ARCH_SUFFIX.tar.gz | tar xz --strip-components=1 atuin-$ARCH_SUFFIX/atuin
chmod +x atuin
mv atuin ~/.local/bin

curl -sS https://starship.rs/install.sh > starship.sh
chmod a+x starship.sh
./starship.sh -y -b ~/.local/bin
rm starship.sh

mkdir -p ~/.local/lib/zsh
if command -v git >/dev/null 2>&1 && command -v zsh >/dev/null 2>&1; then
  git clone -q https://github.com/zsh-users/zsh-syntax-highlighting \
    ~/.local/lib/zsh/zsh-syntax-highlighting

  git clone https://github.com/zsh-users/zsh-autosuggestions \
    ~/.local/lib/zsh/zsh-autosuggestions

  git clone https://github.com/jimhester/per-directory-history \
    ~/.local/lib/zsh/per-directory-history

  PNPM_COMPETITION_VERSION="0.5.5"
  mkdir -p ~/.local/lib/zsh/pnpm-shell-completion
  curl -sSL https://github.com/g-plane/pnpm-shell-completion/releases/download/v$PNPM_COMPETITION_VERSION/pnpm-shell-completion_$ARCH_SUFFIX.tar.gz > ~/pnpm-completion.tar.gz
  tar -xzf ~/pnpm-completion.tar.gz \
    -C ~/.local/lib/zsh/pnpm-shell-completion \
    pnpm-shell-completion pnpm-shell-completion.plugin.zsh
  chmod a+x ~/.local/lib/zsh/pnpm-shell-completion/pnpm-shell-completion
  rm ~/pnpm-completion.tar.gz
fi
