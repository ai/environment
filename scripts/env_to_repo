#!/usr/bin/env ruby
# encoding: utf-8

require 'pathname'
class Pathname
  def glob(pattern, &block)
    Pathname.glob(self.join(pattern).to_s, &block)
  end

  def =~(regexp)
    to_s =~ regexp
  end
end

SCRIPTS = %w{clean_disk env_to_repo env_to_server
             img_to_mail private build-ruby}
DOTS    = %w{bashrc gemrc irbrc gitconfig ackrc bundle/config}

HOME = Pathname('~').expand_path
REPO = HOME.join('.env-repo')
SCRIPT_DIR = HOME.join('Скрипты')

unless REPO.directory?
  `cd ~`
  `git clone git@github.com:ai/environment.git`
  `mv environment #{REPO}`
end
REPO.glob('*') do |i|
  next if i =~ /LICENSE/ or i =~ /README.md/
  i.rmtree
end

DOTS.each do |i|
  if i =~ /\//
    REPO.join(i).dirname.mkpath
  end
  REPO.join(i).make_link(HOME.join(".#{i}"))
end

REPO.join('xkb-options').open('w') do |file|
  config = `dconf read /org/gnome/desktop/input-sources/xkb-options`
  file << config[2..-4].split("', '").sort.inspect.gsub('"', "'") + "\n"
end

REPO.join('scripts').mkpath
SCRIPTS.each { |i| REPO.join('scripts', i).make_link(SCRIPT_DIR.join(i)) }

from = HOME.join('.config/sublime-text-3/Packages/User')
to   = REPO.join('sublime-text-3')

to.mkpath
from.glob('**/*') do |file|
  next if file.to_s =~ /\.cache/
  next if file.extname =~ /^\.ca-/
  next if file.extname == '.last-run'
  to.join(file.relative_path_from(from)).make_link(file)
end
