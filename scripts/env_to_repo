#!/usr/bin/env ruby
# encoding: utf-8

require 'fileutils'
require 'pathname'
class Pathname
  def glob(pattern, &block)
    Pathname.glob(self.join(pattern).to_s, &block)
  end
end

SCRIPTS = %w{clean_disk env_to_repo env_to_server
             img_to_mail private build-ruby}
DOTS    = %w{bashrc gemrc irbrc gitconfig ackrc}

HOME = Pathname('~').expand_path
REPO = HOME.join('.env-repo')
SCRIPT_DIR = HOME.join('Скрипты')

unless REPO.directory?
  `cd ~`
  `git clone git@github.com:ai/environment.git`
  `mv environment #{REPO}`
end
REPO.glob('*') { |i| i.rmtree }

DOTS.each { |i| REPO.join(i).make_link(HOME.join(".#{i}")) }

REPO.join('xkb-options').open('w') do |file|
  file << `dconf read /org/gnome/desktop/input-sources/xkb-options`
end

REPO.join('scripts').mkpath
SCRIPTS.each { |i| REPO.join('scripts', i).make_link(SCRIPT_DIR.join(i)) }

from = HOME.join('.config/sublime-text-2/Packages/User')
to   = REPO.join('sublime-text-2')

to.mkpath
from.glob('**/*') do |file|
  next if file.extname == '.last-run'
  to.join(file.relative_path_from(from)).make_link(file)
end
