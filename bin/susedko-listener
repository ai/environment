#!/bin/bash

source ~/Dev/susedko/secrets.env
MQTT_BROKER=192.168.50.125
USERNAME=home

PREVIOUS_PAYLOAD=""

mosquitto_sub -h "$MQTT_BROKER" -t "ai_laptop" -u home -P "$HOME_PASSWORD" | while read -r payload
do
  power=$(upower -i $(upower -e | grep BAT) | grep "state" | awk '{print $2}')
  if [ "$power" = "charging" ] || [ "$power" = "fully-charged" ] || [ "$power" = "pending-charge" ]; then
    if [ "$payload" != "$PREVIOUS_PAYLOAD" ]; then
      case "$payload" in
        "LOCK")
          loginctl lock-session
          ;;
        "WAKE")
          ydotool key 28:1 28:0
          ;;
        *)
          echo "Unknown command: $payload"
          ;;
      esac
      PREVIOUS_PAYLOAD="$payload"
    fi
  fi
done
