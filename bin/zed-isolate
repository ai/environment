#!/bin/bash

set -e

if [ "$1" != "" ]; then
  cd "$1"
fi

if [[ ! -f .devcontainer.json && ! -d .devcontainer ]]; then
  echo "Create Dev Container"
  cp ~/Dev/environment/devcontainer/devcontainer.json .devcontainer.json
  if [ -d .git ]; then
    echo '.devcontainer.json' >> .git/info/exclude
  fi
fi

~/Dev/environment/bin/dev --up | \
  zenity --progress --text="Starting" --title="Dev Container" --pulsate --auto-close --no-cancel

echo "$?"
if [ "$?" = -1 ]; then
  zenity --error --title="Dev Container Error" --text="devup command failed"
  exit 1
fi

project=$(basename $(pwd))
search_pattern="vsc-$project-[0-9a-f]\+-uid"
container_id=$(podman ps --no-trunc --format '{{.ID}} {{.Image}}' | grep "$search_pattern" | awk '{print $1}')

while true; do
  port=$(shuf -i 1024-9999 -n 1)
  if ! ss -tuln | grep -q ":${port}\s"; then
    break
  fi
done

podman exec --user root $container_id /usr/sbin/sshd -p $port -D &

flatpak run dev.zed.Zed ssh://ai@localhost:$port/workspaces/$project

sleep 5
while netstat -tnp 2>/dev/null | grep ":$port" | grep -q 'ESTABLISHED'; do
  sleep 5
done

~/Dev/environment/bin/dev --down
