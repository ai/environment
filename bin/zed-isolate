#!/bin/bash

set -e

LOG_FILE="/var/run/user/1000/zed-isolate.log"

show_error_log() {
  if [ -f "$LOG_FILE" ]; then
    zenity --text-info \
        --title="Dev Container Error" \
        --font="Lilex Regular 12" \
        --width=800 \
        --height=600 \
        --filename="$LOG_FILE" 2>/dev/null
  fi
  exit 1
}

trap show_error_log ERR

exec > "$LOG_FILE" 2>&1

if [ "$1" != "" ]; then
  cd "$1"
fi

if [[ ! -f package.json ]]; then
  echo "No npm project to use Dev Container"
  flatpak run dev.zed.Zed ./
  exit 0
fi

if [ -f .devcontainer.json ]; then
  config="$(pwd)/.devcontainer.json"
fi
if [ -f .devcontainer/devcontainer.json ]; then
  config="$(pwd)/.devcontainer/devcontainer.json"
fi
if [ "$config" == "" ]; then
  echo "Dev Container is disabled because of lack of Dev Container config"
  flatpak run dev.zed.Zed --new ./
  exit 0
fi

export PATH="/home/ai/.local/lib/node/node_modules/.bin/:$PATH"

echo "Starting Dev Container"
~/Dev/environment/bin/dev --up | \
  zenity --progress --text="Starting" --title="Dev Container" --pulsate --auto-close --no-cancel

container_id=$(podman ps -q --filter label=devcontainer.local_folder=$(pwd))

if [ "$container_id" == "" ]; then
  echo "ERROR: Running container was not found"
  show_error_log
  exit 1
fi

flatpak run dev.zed.Zed --new . --wait

sleep 60
while podman top $container_id | grep zed_server; do
  sleep 30
done

~/Dev/environment/bin/dev --down
