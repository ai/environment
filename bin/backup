#!/bin/sh

export BORG_REPO=ai@susedko.local:/var/mnt/vault/ai/.backup

trap 'echo $( date ) Backup interrupted >&2; exit 2' INT TERM

borg create                                           \
    --verbose                                         \
    --filter AME                                      \
    --list                                            \
    --stats                                           \
    --show-rc                                         \
    --compression lz4                                 \
    --exclude-caches                                  \
    --exclude '*.iso'                                 \
    --exclude '**/node_modules'                       \
    --exclude '**/.mozilla/**/lock'                   \
    --exclude '**/.mozilla/**/crashes'                \
    --exclude '**/.mozilla/**/bookmarkbackups'        \
    --exclude '**/.mozilla/**/datareporting/archived' \
    --exclude '**/.mozilla/**/weave/logs'             \
    --exclude '**/.mozilla/firefox/firefox-mpris'     \
    --exclude '**/*.log'                              \
    --exclude '**/sitnik.ru/dist'                     \
    ::'{hostname}-{now}'                              \
    ~/Dev/susedko                                     \
    ~/Dev/environment                                 \
    ~/Dev/sitnik.ru                                   \
    ~/.ssh                                            \
    ~/.gnupg                                          \
    ~/.Private                                        \
    ~/.config/syncthing                               \
    ~/.local/share/notes                              \
    ~/.mozilla/firefox
backup_exit=$?

echo ""
echo "Pruning repository"
borg prune                         \
    --list                         \
    --glob-archives '{hostname}-*' \
    --show-rc                      \
    --keep-last 1
prune_exit=$?

echo ""
echo "Compacting repository"
borg compact
compact_exit=$?

global_exit=$(( backup_exit > prune_exit ? backup_exit : prune_exit ))
global_exit=$(( compact_exit > global_exit ? compact_exit : global_exit ))

rsync -a --delete --progress \
  --no-perms --no-owner --no-group \
  /home/ai/Vídeos/Erótica/ ai@susedko.local:/var/mnt/vault/ai/Selected

echo ""
if [ ${global_exit} -gt 1 ]; then
  echo "Backup, Prune, and/or Compact finished with errors"
else
  echo "Done"
fi

exit ${global_exit}
